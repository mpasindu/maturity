# PostgreSQL Database with Restored Dump
FROM postgres:15-alpine

# Copy the database dump
COPY maturity_db_backup.dump /tmp/maturity_db_backup.dump

# Create a wrapper entrypoint script that always tries to restore
RUN printf '%s\n' \
  '#!/bin/bash' \
  'set -e' \
  'export PGDATA=/var/lib/postgresql/data/pgdata' \
  '' \
  'if [ ! -s "$PGDATA/PG_VERSION" ]; then' \
  '  echo "Fresh database detected, initializing..."' \
  '  mkdir -p "$PGDATA"' \
  '  chmod 700 "$PGDATA"' \
  '  initdb -U postgres' \
  'fi' \
  '' \
  'if [ -f /tmp/maturity_db_backup.dump ] && [ -z "$(psql -U postgres -d postgres -t -c \"SELECT 1 FROM information_schema.tables WHERE table_schema = '\''public'\'' LIMIT 1;\" 2>/dev/null || true)" ]; then' \
  '  echo "Database is empty, restoring from dump..."' \
  '  pg_restore --clean --if-exists -U postgres -d postgres /tmp/maturity_db_backup.dump 2>&1 || echo "Restore completed with warnings"' \
  '  rm -f /tmp/maturity_db_backup.dump' \
  '  echo "Restore completed"' \
  'fi' \
  '' \
  'exec postgres' > /usr/local/bin/docker-entrypoint-wrapper.sh && \
  chmod +x /usr/local/bin/docker-entrypoint-wrapper.sh

# Set environment variables
ENV POSTGRES_DB=maturity
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=maturity123

# Health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=5 \
    CMD pg_isready -U postgres

EXPOSE 5432

# Use our custom entrypoint
ENTRYPOINT ["/usr/local/bin/docker-entrypoint-wrapper.sh"]
